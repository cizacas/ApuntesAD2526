   UNIDAD 3-parte 2



ACCESO A BASES DE DATOS
 ORIENTADAS A OBJETOS
4.- CLASES JPA ENTITY
Como hemos ido viendo, las clases Entity JPA son clases definidas por el
usuario cuyas instancias se pueden almacenar en una base de datos.
Para almacenar datos en una base de datos ObjectDB utilizando JPA,
debemos definir clases Entity que representen el modelo de objetos de datos
de la aplicación.
Sobre estas clases Entity, vamos a estudiar ahora:
 Tipos persistentes JPA
 Los atributos Entity JPA
 Primary Key
 Valores autogenerados
 Evolución del esquema de base de datos
4.- CLASES JPA ENTITY. Tipos persistentes
Denominamos como tipos persistentes a los tipos de datos que se pueden
usar para almacenar datos en la base de datos. ObjectDB admite los
siguientes tipos persistentes:
 Clases definidas por el usuario: clases Entity y clases integrables
  (Embebable).
 Tipos de datos Java simples: tipos primitivos, Wrappers, String, Date y
  Math.
 Tipos de colecciones: Listas, mapas, arrays.
 Tipos enumerados.
 Tipos serializables (definidos por el usuario o de la API Java).
Solo las instancias de las clases Entity se pueden almacenar directamente en
la base de datos. Otros tipos persistentes se pueden incrustar en clases Entity.
4.- CLASES JPA ENTITY. Tipos persistentes
Clases Entity
Ya hemos visto que la forma más sencila de declarar que una clase es Entity
JPA es, usando únicamente la anotación @Entity:




Una clase Entity, como cualquier otra clase Java, puede extender otra clase o
implementar Interfaces.
Las clases Entity, se representan en las Queries o consultas mediante nombres
de entidad. Por defecto, el nombre de entidad coincide con el nombre de la
clase. Si se quiere usar otro nombre de entidad, hay que usar un modificador
en la anotación @Entity. Por ejemplo:
4.- CLASES JPA ENTITY. Tipos persistentes
Clases Embedable
Una clase Embedable permite instanciar objetos. Pero estos objetos solo
pueden ser persistentes si están integrados dentro de un objeto de una clase
Entity.
Para declarar una clase Embedable, se usa la anotación @Embedable. Por
ejemplo, para declarar una clase Embedable para la dirección de una persona:




Un objeto dirección no se podría persistir directamente pero si se podría si
forma parte de otro objeto de una clase Entity.
4.- CLASES JPA ENTITY. Atributos


Los atributos o campos de una clase Entity JPA, pueden ser de varios tipos
según su comportamiento:


 Atributos transitorios (Transient)
 Atributos persistentes
 Atributos Mapped By
 Atributos Primary Key
 Atributo número de versión
4.- CLASES JPA ENTITY. Atributos

Atributos transitorios (Transient)
Son atributos que, formando parte de una clase Entity JPA, sus valores nunca
se almacenan en la base de datos.
Los atributos declarados static o final son atributos transitorios.
Podemos establecer explícitamente que otros atributos de una clase Entity
JPA se comporten como transitorios mediante la anotación @Transient. Por
ejemplo:
4.- CLASES JPA ENTITY. Atributos

Atributos persistentes


 Son todos los atributos que, formando parte de una clase Entity JPA, son
  persistidos cuando se persiste o graba un objeto de la clase.
 Realmente todos los que no son transitorios, son persistentes.
 Cuando se graba un objeto persistente, todos sus atributos deben
  pertenecer a un tipo persistente. Sus atributos pueden contener nulos.
 Al grabar objetos persistente, sólo se graba el estado (valor) de sus
  atributos, no el código de los métodos de la clase Entity, si los tuviera.
4.- CLASES JPA ENTITY. Atributos

Atributos persistentes


Los atributos persistentes se pueden marcar con cualquiera de las siguientes
anotaciones:
@OneToOne, @ManyToOne – Para referenciar a otro objeto persistente.
@OneToMany, @ManyToMany – Para referenciar a colecciones de objetos
persistentes.
@Basic – No se require, por defecto, se considera que un atributo es Basic.
@Embedded – Para anotar un atributo perteneciente a un objeto de una
clase Embedable. No se requiere, salvo que se trata de un Id.
4.- CLASES JPA ENTITY. Atributos

Atributos Mapped By
Son atributos que contienen datos que no se almacenan como parte del
objeto en que están declarados. Pero son accesibles cuando se consultan
mediante una consulta.
Para declarar los atributos Mapped By, se usan las anotaciones @OneToOne,
@ManyToOne, @OneToMany, @ManyToMany.
Para conocer de forma básica estas anotaciones, vamos primero a desarrollar
una clase Entity JPA Departamento.
4.- CLASES JPA ENTITY. Atributos

Atributos Mapped By
Una vez que tenemos la Entity Class Departamento y la Entity Class
Empleado, vamos a añadir a la clase Empleado un atributo Departamento
que referenciará al objeto Departamento correspondiente al departamento al
que pertenezca cada empleado.
                                             Se anota con @ManyToOne para
                                             indicar la relación varios empleados en
                                             un departamento



Y vamos a añadir a la clase Departamento un atributo de tipo colección de
objetos Empleado que referencie a todos los empleados del Departamento.
                                             Se anota con @OneToMay para indicar
                                             la relación en un departamento hay
                                             varios empleados. Se requiere asignar
                                             el nombre del atributo de la clase
                                             Empleado con que se relaciona la lista.
4.- CLASES JPA ENTITY. Atributos

Atributos Mapped By
Ahora vamos a usar la anotación @OneToOne para hacer referencias UNO A
UNO entre Empleado y Departamento.
En Departamento vamos a añadir un atributo Empleado que sirva para
contener quien es el jefe de cada departamento.




Para reflejar en un empleado que es jefe de un departamento, tenemos dos
alternativas: usar un atributo esJefe de tipo booleano o usar un atributo de
tipo Departamento mapeado a jefe que, si contiene algo es que es jefe del
departamento y si tiene null no es jefe. Esto se haría así:
4.- CLASES JPA ENTITY. Atributos

Primary Key
Como ya hemos visto, toda Entity Class debe contener un atributo Id o
Primary Key.
Una vez almacenado un objeto persistente, ya no será posible modificar su Id.
Por defecto, cuando se crea un atributo @Id, se crea de tipo long y
autoincrementado, usando las siguientes anotaciones:




Eso que se hace por defecto, es equivalente a establecer la estrategia de
generación de valores de esta forma:
4.- CLASES JPA ENTITY. Atributos
Primary Key
Hay otras estrategias de generación automática de valores a un Id. Aunque no
las vamos a usar, puedes consultarlas en:
https://www.objectdb.com/java/jpa/entity/generated#the_identity_strategy

Aunque un Id sea de generación automática, se le pueden asignar valores. En
su caso, el generador automático no se resincroniza a esos valores asignados.
Para hacer que un Id no sea de generación automática, haríamos:




Para almacenar cada objeto con un Id de tipo UUID, haríamos:
 4.- CLASES JPA ENTITY. Atributos
Evolución del esquema
Cuando se modifica el esquema de la base de datos (se añade un atributo, se
elimina, se cambia de tipo, se añade una clase, etc.), si un objeto guardado con
el esquema antiguo se lee, se convierte automáticamente en una instancia
actualizada de la clase.
Mientras un objeto "antiguo" no se lea, permanecerá como instancia del
esquema antiguo.
Cuando se actualizan los objetos a un esquema nuevo, hay unas reglas que se
cumplen en la transformación de los datos como, por ejemplo:
• Los atributos del esquema antiguo que no tienen atributos coincidentes en
  el nuevo esquema simplemente se ignoran (y se pierde su contenido)

Pero estas reglas, como se aplican con cierta lógica, no es necesario que
las tengamos en cuenta.
